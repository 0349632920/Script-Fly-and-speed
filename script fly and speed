-- StarterPlayerScripts/OneScript_PrettyGUI.client.lua
-- 1 SCRIPT DUY NHẤT: GUI đẹp hơn + Key + Fly/Speed + AntiRagdoll + GhostMode + TrainingMode + InfJump/FiniteJump
-- (TrainingMode: hồi máu trong Part tên "SafeZone" nếu có)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- ================= THEME =================
local THEME = {
	Bg = Color3.fromRGB(18, 20, 26),
	Panel = Color3.fromRGB(24, 27, 35),
	Panel2 = Color3.fromRGB(28, 32, 42),
	Stroke = Color3.fromRGB(65, 74, 96),
	Text = Color3.fromRGB(235, 240, 255),
	Muted = Color3.fromRGB(165, 175, 200),
	Good = Color3.fromRGB(90, 210, 140),
	Bad = Color3.fromRGB(240, 90, 90),
	Accent = Color3.fromRGB(120, 170, 255),
}

local function notify(title, text, seconds)
	pcall(function()
		StarterGui:SetCore("SendNotification", {
			Title = title or "INFO",
			Text = text or "",
			Duration = seconds or 3
		})
	end)
end

local function mk(className, props, parent)
	local o = Instance.new(className)
	for k, v in pairs(props or {}) do o[k] = v end
	o.Parent = parent
	return o
end

local function roundify(guiObj, radius)
	mk("UICorner", {CornerRadius = UDim.new(0, radius or 10)}, guiObj)
end

local function stroke(guiObj, thickness)
	mk("UIStroke", {Thickness = thickness or 1, Color = THEME.Stroke, Transparency = 0.15}, guiObj)
end

local function padding(guiObj, p)
	mk("UIPadding", {PaddingTop=UDim.new(0,p),PaddingBottom=UDim.new(0,p),PaddingLeft=UDim.new(0,p),PaddingRight=UDim.new(0,p)}, guiObj)
end

local function shadow(parent, size, pos)
	local s = mk("ImageLabel", {
		BackgroundTransparency = 1,
		Image = "rbxassetid://1316045217", -- soft shadow
		ImageTransparency = 0.55,
		ScaleType = Enum.ScaleType.Slice,
		SliceCenter = Rect.new(10,10,118,118),
		Size = size,
		Position = pos,
		ZIndex = 0,
	}, parent)
	return s
end

local function makeButton(parent, text, height)
	local btn = mk("TextButton", {
		BackgroundColor3 = THEME.Panel2,
		AutoButtonColor = true,
		Text = text or "Button",
		TextColor3 = THEME.Text,
		TextSize = 16,
		Font = Enum.Font.GothamSemibold,
		Size = UDim2.new(1, 0, 0, height or 38),
	}, parent)
	roundify(btn, 10)
	stroke(btn, 1)
	return btn
end

local function makeSmallButton(parent, text, w, h)
	local btn = mk("TextButton", {
		BackgroundColor3 = THEME.Panel2,
		AutoButtonColor = true,
		Text = text or "+",
		TextColor3 = THEME.Text,
		TextSize = 16,
		Font = Enum.Font.GothamSemibold,
		Size = UDim2.new(0, w or 46, 0, h or 34),
	}, parent)
	roundify(btn, 10)
	stroke(btn, 1)
	return btn
end

local function makeLabel(parent, text, size)
	local lb = mk("TextLabel", {
		BackgroundTransparency = 1,
		Text = text or "",
		TextColor3 = THEME.Text,
		TextSize = size or 16,
		Font = Enum.Font.GothamSemibold,
		TextXAlignment = Enum.TextXAlignment.Left,
		Size = UDim2.new(1, 0, 0, 20),
	}, parent)
	return lb
end

local function makeMuted(parent, text, size)
	local lb = mk("TextLabel", {
		BackgroundTransparency = 1,
		Text = text or "",
		TextColor3 = THEME.Muted,
		TextSize = size or 14,
		Font = Enum.Font.Gotham,
		TextXAlignment = Enum.TextXAlignment.Left,
		Size = UDim2.new(1, 0, 0, 18),
	}, parent)
	return lb
end

local function clamp(n,a,b) return math.max(a, math.min(b,n)) end
local function getChar() return player.Character or player.CharacterAdded:Wait() end
local function getHumanoid() return getChar():WaitForChild("Humanoid") end
local function getHRP() return getChar():WaitForChild("HumanoidRootPart") end

-- ================= CLEAN OLD GUI =================
local old = playerGui:FindFirstChild("OnePrettyGUI")
if old then old:Destroy() end

local gui = mk("ScreenGui", {Name="OnePrettyGUI", ResetOnSpawn=false, IgnoreGuiInset=true}, playerGui)

-- ================= KEY / ACCESS =================
local KEY_OK = "HUNGSCRIPT-3456"
local access = false

-- ================= FEATURES STATE =================
local WALK_MIN, WALK_MAX, WALK_STEP = 16, 200, 10
local FLY_MIN,  FLY_MAX,  FLY_STEP  = 20, 200, 10
local FIN_MAX_LIMIT = 10
local FIN_BOOST_LIMIT = 200

local flyEnabled = false
local walkSpeed = 16
local flySpeed = 60
local bv, bg, flyConn

local antiRagdoll = false
local antiHBConn

local ghostEnabled = false
local ghostConn
local lastPos
local stuckTime = 0

local trainingEnabled = false
local trainingConn

local infJump = false
local finEnabled = false
local finMaxAir = 2
local finBoost = 55
local usedAir = 0

local function isGrounded(hum)
	local st = hum:GetState()
	return st == Enum.HumanoidStateType.Running
		or st == Enum.HumanoidStateType.RunningNoPhysics
		or st == Enum.HumanoidStateType.Landed
end

local function applyWalkSpeed()
	getHumanoid().WalkSpeed = walkSpeed
end

-- ================= FLY =================
local function stopFly()
	if not flyEnabled then return end
	flyEnabled = false
	if flyConn then flyConn:Disconnect() flyConn=nil end
	if bv then bv:Destroy() bv=nil end
	if bg then bg:Destroy() bg=nil end
end

local function startFly()
	if flyEnabled then return end
	flyEnabled = true

	local hrp = getHRP()
	bv = Instance.new("BodyVelocity")
	bv.MaxForce = Vector3.new(1e9, 1e9, 1e9)
	bv.Velocity = Vector3.zero
	bv.Parent = hrp

	bg = Instance.new("BodyGyro")
	bg.MaxTorque = Vector3.new(1e9, 1e9, 1e9)
	bg.P = 9e4
	bg.CFrame = hrp.CFrame
	bg.Parent = hrp

	flyConn = RunService.RenderStepped:Connect(function()
		local cam = workspace.CurrentCamera
		if not cam or not hrp then return end

		local move = Vector3.zero
		if UIS:IsKeyDown(Enum.KeyCode.W) then move += cam.CFrame.LookVector end
		if UIS:IsKeyDown(Enum.KeyCode.S) then move -= cam.CFrame.LookVector end
		if UIS:IsKeyDown(Enum.KeyCode.A) then move -= cam.CFrame.RightVector end
		if UIS:IsKeyDown(Enum.KeyCode.D) then move += cam.CFrame.RightVector end
		if UIS:IsKeyDown(Enum.KeyCode.Space) then move += Vector3.new(0,1,0) end
		if UIS:IsKeyDown(Enum.KeyCode.LeftControl) then move -= Vector3.new(0,1,0) end

		if move.Magnitude > 0 then move = move.Unit * flySpeed end
		bv.Velocity = move
		bg.CFrame = cam.CFrame
	end)
end

-- ================= GHOST =================
local function GhostStep(studs)
	studs = studs or 6
	local char = player.Character
	if not char then return end
	local hrp = char:FindFirstChild("HumanoidRootPart")
	if not hrp then return end
	local cam = workspace.CurrentCamera
	if not cam then return end

	local dir = cam.CFrame.LookVector
	local flat = Vector3.new(dir.X, 0, dir.Z)
	if flat.Magnitude < 0.01 then return end
	flat = flat.Unit

	local start = hrp.Position + Vector3.new(0, 2, 0)
	local target = hrp.Position + flat * studs + Vector3.new(0, 2, 0)

	local params = RaycastParams.new()
	params.FilterType = Enum.RaycastFilterType.Exclude
	params.FilterDescendantsInstances = {char}

	local hit = workspace:Raycast(start, (target - start), params)
	if hit then target = hit.Position - flat * 1 end

	local rot = hrp.CFrame - hrp.Position
	hrp.AssemblyLinearVelocity = Vector3.zero
	hrp.CFrame = CFrame.new(target) * rot
end

local function setGhostMode(state)
	ghostEnabled = state
	if ghostConn then ghostConn:Disconnect() ghostConn=nil end
	lastPos, stuckTime = nil, 0
	if not ghostEnabled then return end

	ghostConn = RunService.Heartbeat:Connect(function(dt)
		local char = player.Character
		if not char then return end
		local hrp = char:FindFirstChild("HumanoidRootPart")
		local hum = char:FindFirstChildOfClass("Humanoid")
		if not hrp or not hum then return end

		if flyEnabled then
			lastPos = hrp.Position
			stuckTime = 0
			return
		end

		local movingKey =
			UIS:IsKeyDown(Enum.KeyCode.W) or UIS:IsKeyDown(Enum.KeyCode.A) or
			UIS:IsKeyDown(Enum.KeyCode.S) or UIS:IsKeyDown(Enum.KeyCode.D)

		if not movingKey then
			lastPos = hrp.Position
			stuckTime = 0
			return
		end

		if not lastPos then lastPos = hrp.Position return end

		local moved = (hrp.Position - lastPos).Magnitude
		lastPos = hrp.Position

		if moved < 0.05 and hum.MoveDirection.Magnitude > 0.05 then
			stuckTime += dt
			if stuckTime >= 0.35 then
				stuckTime = 0
				GhostStep(4)
			end
		else
			stuckTime = 0
		end
	end)
end

-- ================= TRAINING (SafeZone) =================
local function inSafeZone()
	local zone = workspace:FindFirstChild("SafeZone")
	if not zone or not zone:IsA("BasePart") then return false end
	local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
	if not hrp then return false end
	local lp = zone.CFrame:PointToObjectSpace(hrp.Position)
	return math.abs(lp.X) <= zone.Size.X/2
		and math.abs(lp.Y) <= zone.Size.Y/2
		and math.abs(lp.Z) <= zone.Size.Z/2
end

local function setTrainingMode(state)
	trainingEnabled = state
	if trainingConn then trainingConn:Disconnect() trainingConn=nil end
	if not trainingEnabled then return end

	trainingConn = RunService.Heartbeat:Connect(function()
		local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
		if not hum then return end
		if inSafeZone() and hum.Health < hum.MaxHealth then
			hum.Health = hum.MaxHealth
		end
	end)
end

-- ================= ANTI RAGDOLL (MOTOR6D FIX) =================
local function setAntiRagdoll(state)
	antiRagdoll = state
	if antiHBConn then antiHBConn:Disconnect() antiHBConn=nil end
	if not antiRagdoll then return end

	antiHBConn = RunService.Heartbeat:Connect(function()
		if not antiRagdoll then return end
		local char = player.Character
		if not char then return end
		local hum = char:FindFirstChildOfClass("Humanoid")
		if not hum then return end

		if hum.PlatformStand then hum.PlatformStand = false end
		if hum.Sit then hum.Sit = false end

		local st = hum:GetState()
		if st == Enum.HumanoidStateType.Ragdoll
			or st == Enum.HumanoidStateType.FallingDown
			or st == Enum.HumanoidStateType.Physics then
			pcall(function()
				hum:ChangeState(Enum.HumanoidStateType.GettingUp)
			end)
		end

		for _, d in ipairs(char:GetDescendants()) do
			if d:IsA("Motor6D") and d.Enabled == false then
				d.Enabled = true
			end
		end
	end)
end

-- ================= GROUND RESET =================
local function hookGroundReset()
	local hum = getHumanoid()
	hum.StateChanged:Connect(function(_, newState)
		if newState == Enum.HumanoidStateType.Landed
			or newState == Enum.HumanoidStateType.Running
			or newState == Enum.HumanoidStateType.RunningNoPhysics then
			usedAir = 0
		end
	end)
end

-- ================= MAIN WINDOW (PRETTY) =================
local root = mk("Frame", {
	Size = UDim2.new(0, 760, 0, 430),
	Position = UDim2.new(0.5, -380, 0.5, -215),
	BackgroundColor3 = THEME.Bg,
	BackgroundTransparency = 0.02,
}, gui)
root.ZIndex = 2
roundify(root, 14)
stroke(root, 1)
padding(root, 12)
shadow(gui, root.Size + UDim2.new(0, 30, 0, 30), root.Position - UDim2.new(0, 15, 0, 15)).ZIndex = 1

-- Topbar
local top = mk("Frame", {
	Size = UDim2.new(1, 0, 0, 44),
	BackgroundColor3 = THEME.Panel,
	BackgroundTransparency = 0,
}, root)
roundify(top, 14)
stroke(top, 1)
padding(top, 10)

local title = mk("TextLabel", {
	BackgroundTransparency = 1,
	Text = "ONE SCRIPT PANEL",
	TextColor3 = THEME.Text,
	Font = Enum.Font.GothamBold,
	TextSize = 16,
	TextXAlignment = Enum.TextXAlignment.Left,
	Size = UDim2.new(1, -120, 1, 0),
}, top)

local btnBar = mk("Frame", {
	BackgroundTransparency = 1,
	Size = UDim2.new(0, 110, 1, 0),
	Position = UDim2.new(1, -110, 0, 0),
}, top)

local uiList = mk("UIListLayout", {
	FillDirection = Enum.FillDirection.Horizontal,
	HorizontalAlignment = Enum.HorizontalAlignment.Right,
	VerticalAlignment = Enum.VerticalAlignment.Center,
	Padding = UDim.new(0, 8),
}, btnBar)

local minBtn = makeSmallButton(btnBar, "—", 46, 28)
local closeBtn = makeSmallButton(btnBar, "X", 46, 28)
closeBtn.BackgroundColor3 = Color3.fromRGB(50, 25, 25)
minBtn.BackgroundColor3 = Color3.fromRGB(26, 32, 45)

-- Content area
local content = mk("Frame", {
	BackgroundTransparency = 1,
	Size = UDim2.new(1, 0, 1, -54),
	Position = UDim2.new(0, 0, 0, 54),
}, root)

local columns = mk("UIListLayout", {
	FillDirection = Enum.FillDirection.Horizontal,
	HorizontalAlignment = Enum.HorizontalAlignment.Center,
	VerticalAlignment = Enum.VerticalAlignment.Top,
	Padding = UDim.new(0, 12),
}, content)

local left = mk("Frame", {
	BackgroundColor3 = THEME.Panel,
	Size = UDim2.new(0.5, -6, 1, 0),
}, content)
roundify(left, 14); stroke(left, 1); padding(left, 12)

local right = mk("Frame", {
	BackgroundColor3 = THEME.Panel,
	Size = UDim2.new(0.5, -6, 1, 0),
}, content)
roundify(right, 14); stroke(right, 1); padding(right, 12)

local function makeSection(parent, headerText)
	local box = mk("Frame", {BackgroundTransparency=1, Size=UDim2.new(1,0,0,0), AutomaticSize=Enum.AutomaticSize.Y}, parent)
	local head = makeLabel(box, headerText, 16)
	head.Font = Enum.Font.GothamBold
	local line = mk("Frame", {BackgroundColor3=THEME.Stroke, BackgroundTransparency=0.65, Size=UDim2.new(1,0,0,1)}, box)
	local list = mk("UIListLayout", {Padding=UDim.new(0,10)}, box)
	list.SortOrder = Enum.SortOrder.LayoutOrder
	return box
end

local function makeRow(parent)
	local row = mk("Frame", {BackgroundTransparency=1, Size=UDim2.new(1,0,0,38)}, parent)
	local l = mk("UIListLayout", {FillDirection=Enum.FillDirection.Horizontal, Padding=UDim.new(0,8), VerticalAlignment=Enum.VerticalAlignment.Center}, row)
	return row
end

-- draggable
do
	local dragging = false
	local dragStart, startPos
	top.InputBegan:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			dragStart = i.Position
			startPos = root.Position
		end
	end)
	top.InputEnded:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
	end)
	UIS.InputChanged:Connect(function(i)
		if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
			local delta = i.Position - dragStart
			root.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
		end
	end)
end

-- minimize / close
local minimized = false
minBtn.MouseButton1Click:Connect(function()
	minimized = not minimized
	content.Visible = not minimized
	root.Size = minimized and UDim2.new(0, 760, 0, 64) or UDim2.new(0, 760, 0, 430)
end)
closeBtn.MouseButton1Click:Connect(function()
	gui:Destroy()
end)

-- ================= KEY MODAL (PRETTY) =================
local modal = mk("Frame", {
	BackgroundColor3 = Color3.fromRGB(0,0,0),
	BackgroundTransparency = 0.35,
	Size = UDim2.new(1,0,1,0),
	Visible = true,
}, gui)
modal.ZIndex = 50

local keyCard = mk("Frame", {
	BackgroundColor3 = THEME.Panel,
	Size = UDim2.new(0, 420, 0, 230),
	Position = UDim2.new(0.5, -210, 0.5, -115),
}, modal)
keyCard.ZIndex = 51
roundify(keyCard, 16); stroke(keyCard, 1); padding(keyCard, 14)
shadow(modal, keyCard.Size + UDim2.new(0,30,0,30), keyCard.Position - UDim2.new(0,15,0,15)).ZIndex = 50

local kTitle = mk("TextLabel", {
	BackgroundTransparency = 1,
	Text = "NHẬP KEY",
	TextColor3 = THEME.Text,
	Font = Enum.Font.GothamBold,
	TextSize = 18,
	Size = UDim2.new(1,0,0,26),
	ZIndex = 52,
}, keyCard)

local kHint = mk("TextLabel", {
	BackgroundTransparency = 1,
	Text = "Nhập key để mở chức năng",
	TextColor3 = THEME.Muted,
	Font = Enum.Font.Gotham,
	TextSize = 14,
	TextXAlignment = Enum.TextXAlignment.Left,
	Size = UDim2.new(1,0,0,20),
	Position = UDim2.new(0,0,0,32),
	ZIndex = 52,
}, keyCard)

local keyBox = mk("TextBox", {
	BackgroundColor3 = THEME.Panel2,
	Text = "",
	PlaceholderText = "Key...",
	ClearTextOnFocus = false,
	TextColor3 = THEME.Text,
	PlaceholderColor3 = THEME.Muted,
	Font = Enum.Font.GothamSemibold,
	TextSize = 16,
	Size = UDim2.new(1,0,0,44),
	Position = UDim2.new(0,0,0,70),
	ZIndex = 52,
}, keyCard)
roundify(keyBox, 12); stroke(keyBox, 1); padding(keyBox, 10)

local kMsg = mk("TextLabel", {
	BackgroundTransparency = 1,
	Text = "",
	TextColor3 = THEME.Muted,
	Font = Enum.Font.Gotham,
	TextSize = 14,
	TextXAlignment = Enum.TextXAlignment.Left,
	Size = UDim2.new(1,0,0,18),
	Position = UDim2.new(0,0,0,120),
	ZIndex = 52,
}, keyCard)

local kBtn = mk("TextButton", {
	BackgroundColor3 = THEME.Accent,
	Text = "MỞ MENU",
	TextColor3 = Color3.fromRGB(10,12,16),
	Font = Enum.Font.GothamBold,
	TextSize = 16,
	Size = UDim2.new(1,0,0,44),
	Position = UDim2.new(0,0,0,150),
	ZIndex = 52,
}, keyCard)
roundify(kBtn, 12)

local kTip = mk("TextLabel", {
	BackgroundTransparency = 1,
	Text = "Phím P: ẩn/hiện menu",
	TextColor3 = THEME.Muted,
	Font = Enum.Font.Gotham,
	TextSize = 13,
	TextXAlignment = Enum.TextXAlignment.Left,
	Size = UDim2.new(1,0,0,18),
	Position = UDim2.new(0,0,0,200),
	ZIndex = 52,
}, keyCard)

-- ================= UI CONTROLS =================
local function setToggleText(btn, label, on)
	btn.Text = label .. ": " .. (on and "BẬT" or "TẮT")
	btn.BackgroundColor3 = on and Color3.fromRGB(28, 44, 34) or THEME.Panel2
end

local jumpSec = makeSection(left, "JUMP")
local infBtn = makeButton(jumpSec, "INF JUMP: TẮT", 40)
local finBtn = makeButton(jumpSec, "FINITE JUMP: TẮT", 40)

local row1 = makeRow(jumpSec)
local finMaxLabel = makeLabel(row1, "Số nhảy: 2", 14); finMaxLabel.TextColor3 = THEME.Muted
local finMaxMinus = makeSmallButton(row1, "−", 40, 34)
local finMaxPlus = makeSmallButton(row1, "+", 40, 34)

local row2 = makeRow(jumpSec)
local finBoostLabel = makeLabel(row2, "Lực nhảy: 55", 14); finBoostLabel.TextColor3 = THEME.Muted
local finBoostMinus = makeSmallButton(row2, "−", 40, 34)
local finBoostPlus = makeSmallButton(row2, "+", 40, 34)

makeMuted(jumpSec, "Mẹo: Finite/Inf chỉ tác dụng khi đang ở trên không.", 13)

local moveSec = makeSection(right, "MOVE")
local flyBtn = makeButton(moveSec, "BAY: TẮT", 42)

local row3 = makeRow(moveSec)
local speedLabel = makeLabel(row3, "Speed: 16", 14); speedLabel.TextColor3 = THEME.Muted
local spMinus = makeSmallButton(row3, "−", 40, 34)
local spPlus = makeSmallButton(row3, "+", 40, 34)

local row4 = makeRow(moveSec)
local flySpeedLabel = makeLabel(row4, "Fly Speed: 60", 14); flySpeedLabel.TextColor3 = THEME.Muted
local fsMinus = makeSmallButton(row4, "−", 40, 34)
local fsPlus = makeSmallButton(row4, "+", 40, 34)

local antiBtn = makeButton(moveSec, "ANTI RAGDOLL: TẮT", 38)
local ghostBtn = makeButton(moveSec, "GHOST MODE: TẮT", 38)
local ghostStepBtn = makeButton(moveSec, "GHOST STEP", 38)
local trainBtn = makeButton(moveSec, "TRAINING MODE: TẮT", 38)

makeMuted(moveSec, "Bay: WASD • Space lên • Ctrl xuống", 13)
makeMuted(moveSec, "Training: hồi máu trong Part 'SafeZone' (nếu có).", 13)

local function refreshUI()
	setToggleText(infBtn, "INF JUMP", infJump)
	setToggleText(finBtn, "FINITE JUMP", finEnabled)
	finMaxLabel.Text = ("Số nhảy: %d"):format(finMaxAir)
	finBoostLabel.Text = ("Lực nhảy: %d"):format(finBoost)

	setToggleText(flyBtn, "BAY", flyEnabled)
	speedLabel.Text = ("Speed: %d"):format(walkSpeed)
	flySpeedLabel.Text = ("Fly Speed: %d"):format(flySpeed)

	setToggleText(antiBtn, "ANTI RAGDOLL", antiRagdoll)
	setToggleText(ghostBtn, "GHOST MODE", ghostEnabled)
	setToggleText(trainBtn, "TRAINING MODE", trainingEnabled)
end

-- ================= EVENTS =================
infBtn.MouseButton1Click:Connect(function()
	infJump = not infJump
	refreshUI()
end)

finBtn.MouseButton1Click:Connect(function()
	finEnabled = not finEnabled
	refreshUI()
end)

finMaxMinus.MouseButton1Click:Connect(function()
	finMaxAir = clamp(finMaxAir - 1, 0, FIN_MAX_LIMIT)
	refreshUI()
end)
finMaxPlus.MouseButton1Click:Connect(function()
	finMaxAir = clamp(finMaxAir + 1, 0, FIN_MAX_LIMIT)
	refreshUI()
end)

finBoostMinus.MouseButton1Click:Connect(function()
	finBoost = clamp(finBoost - 5, 10, FIN_BOOST_LIMIT)
	refreshUI()
end)
finBoostPlus.MouseButton1Click:Connect(function()
	finBoost = clamp(finBoost + 5, 10, FIN_BOOST_LIMIT)
	refreshUI()
end)

flyBtn.MouseButton1Click:Connect(function()
	if flyEnabled then stopFly() else startFly() end
	refreshUI()
end)

spMinus.MouseButton1Click:Connect(function()
	walkSpeed = clamp(walkSpeed - WALK_STEP, WALK_MIN, WALK_MAX)
	applyWalkSpeed()
	refreshUI()
end)
spPlus.MouseButton1Click:Connect(function()
	walkSpeed = clamp(walkSpeed + WALK_STEP, WALK_MIN, WALK_MAX)
	applyWalkSpeed()
	refreshUI()
end)

fsMinus.MouseButton1Click:Connect(function()
	flySpeed = clamp(flySpeed - FLY_STEP, FLY_MIN, FLY_MAX)
	refreshUI()
end)
fsPlus.MouseButton1Click:Connect(function()
	flySpeed = clamp(flySpeed + FLY_STEP, FLY_MIN, FLY_MAX)
	refreshUI()
end)

antiBtn.MouseButton1Click:Connect(function()
	setAntiRagdoll(not antiRagdoll)
	refreshUI()
end)

ghostBtn.MouseButton1Click:Connect(function()
	setGhostMode(not ghostEnabled)
	refreshUI()
end)

ghostStepBtn.MouseButton1Click:Connect(function()
	GhostStep(6)
end)

trainBtn.MouseButton1Click:Connect(function()
	setTrainingMode(not trainingEnabled)
	refreshUI()
end)

-- P hide/show
UIS.InputBegan:Connect(function(inputObj, gp)
	if gp then return end
	if not access then return end

	if inputObj.KeyCode == Enum.KeyCode.P then
		root.Visible = not root.Visible
	end

	-- Jump handling (Inf/Finite)
	if inputObj.KeyCode == Enum.KeyCode.Space then
		local hum = getHumanoid()
		local hrp = getHRP()

		if infJump then
			if not isGrounded(hum) then
				local v = hrp.AssemblyLinearVelocity
				hrp.AssemblyLinearVelocity = Vector3.new(v.X, math.max(v.Y, finBoost), v.Z)
			end
			return
		end

		if finEnabled then
			if isGrounded(hum) then
				usedAir = 0
				return
			end
			if usedAir >= finMaxAir then return end
			usedAir += 1
			local v = hrp.AssemblyLinearVelocity
			hrp.AssemblyLinearVelocity = Vector3.new(v.X, math.max(v.Y, finBoost), v.Z)
		end
	end
end)

hookGroundReset()

player.CharacterAdded:Connect(function()
	stopFly()
	if ghostConn then ghostConn:Disconnect() ghostConn=nil end
	if trainingConn then trainingConn:Disconnect() trainingConn=nil end
	if antiHBConn then antiHBConn:Disconnect() antiHBConn=nil end

	task.wait(0.1)
	applyWalkSpeed()
	if antiRagdoll then setAntiRagdoll(true) end
	if ghostEnabled then setGhostMode(true) end
	if trainingEnabled then setTrainingMode(true) end

	usedAir = 0
	hookGroundReset()
end)

-- ================= KEY BUTTON =================
local function unlock()
	access = true
	modal.Visible = false
	root.Visible = true
	refreshUI()
	applyWalkSpeed()
	notify("OK", "Menu đã load xong ✅", 3)
end

kBtn.MouseButton1Click:Connect(function()
	local k = (keyBox.Text or ""):upper():gsub("%s+", "")
	if k == KEY_OK then
		kMsg.TextColor3 = THEME.Good
		kMsg.Text = "✅ Key đúng!"
		unlock()
	else
		kMsg.TextColor3 = THEME.Bad
		kMsg.Text = "❌ Key sai!"
	end
end)

-- init
root.Visible = false
refreshUI()

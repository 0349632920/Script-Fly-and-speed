-- StarterPlayerScripts/AutoCreateGuiFlySpeed.client.lua  (LocalScript)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- ===== CONFIG =====
local WALK_MIN, WALK_MAX, WALK_STEP = 16, 200, 10
local FLY_MIN,  FLY_MAX,  FLY_STEP  = 20, 200, 10

local walkSpeed = 16
local flySpeed = 60

-- ===== HELPERS =====
local function new(inst, props, parent)
	local obj = Instance.new(inst)
	for k, v in pairs(props) do obj[k] = v end
	obj.Parent = parent
	return obj
end

local function clamp(n, a, b)
	return math.max(a, math.min(b, n))
end

local function getChar()
	return player.Character or player.CharacterAdded:Wait()
end

local function getHumanoid()
	return getChar():WaitForChild("Humanoid")
end

local function getHRP()
	return getChar():WaitForChild("HumanoidRootPart")
end

-- ===== FLY LOGIC =====
local flying = false
local bv, bg, conn

local function stopFly()
	if not flying then return end
	flying = false
	if conn then conn:Disconnect() conn = nil end
	if bv then bv:Destroy() bv = nil end
	if bg then bg:Destroy() bg = nil end
end

local function startFly(toggleBtn)
	if flying then return end
	flying = true

	local hrp = getHRP()

	bv = Instance.new("BodyVelocity")
	bv.MaxForce = Vector3.new(1e9, 1e9, 1e9)
	bv.Velocity = Vector3.zero
	bv.Parent = hrp

	bg = Instance.new("BodyGyro")
	bg.MaxTorque = Vector3.new(1e9, 1e9, 1e9)
	bg.P = 9e4
	bg.CFrame = hrp.CFrame
	bg.Parent = hrp

	conn = RunService.RenderStepped:Connect(function()
		local cam = workspace.CurrentCamera
		if not cam or not hrp then return end

		local move = Vector3.zero
		if UserInputService:IsKeyDown(Enum.KeyCode.W) then move += cam.CFrame.LookVector end
		if UserInputService:IsKeyDown(Enum.KeyCode.S) then move -= cam.CFrame.LookVector end
		if UserInputService:IsKeyDown(Enum.KeyCode.A) then move -= cam.CFrame.RightVector end
		if UserInputService:IsKeyDown(Enum.KeyCode.D) then move += cam.CFrame.RightVector end
		if UserInputService:IsKeyDown(Enum.KeyCode.Space) then move += Vector3.new(0, 1, 0) end
		if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then move -= Vector3.new(0, 1, 0) end

		if move.Magnitude > 0 then
			move = move.Unit * flySpeed
		end

		bv.Velocity = move
		bg.CFrame = cam.CFrame
	end)
end

-- ===== CREATE GUI (AUTO) =====
local old = playerGui:FindFirstChild("AutoFlySpeedGui")
if old then old:Destroy() end

local gui = new("ScreenGui", {
	Name = "AutoFlySpeedGui",
	ResetOnSpawn = false
}, playerGui)

local panel = new("Frame", {
	Name = "ControlPanel",
	Size = UDim2.new(0, 350, 0, 200),
	Position = UDim2.new(1, -370, 1, -240),
	BackgroundTransparency = 0.15
}, gui)

-- Top bar
local topBar = new("Frame", {
	Name = "TopBar",
	Size = UDim2.new(1, 0, 0, 36),
	Position = UDim2.new(0, 0, 0, 0),
	BackgroundTransparency = 0.25
}, panel)

local title = new("TextLabel", {
	Size = UDim2.new(1, -110, 1, 0),
	Position = UDim2.new(0, 10, 0, 0),
	BackgroundTransparency = 1,
	TextScaled = true,
	TextXAlignment = Enum.TextXAlignment.Left,
	Text = "FLY + SPEED"
}, topBar)

local btnHide = new("TextButton", {
	Name = "HideBtn",
	Size = UDim2.new(0, 45, 0, 26),
	Position = UDim2.new(1, -100, 0.5, -13),
	TextScaled = true,
	Text = "_"
}, topBar)

local btnClose = new("TextButton", {
	Name = "CloseBtn",
	Size = UDim2.new(0, 45, 0, 26),
	Position = UDim2.new(1, -50, 0.5, -13),
	TextScaled = true,
	Text = "X"
}, topBar)

-- Content frame (phần sẽ ẩn/hiện)
local content = new("Frame", {
	Name = "Content",
	Size = UDim2.new(1, 0, 1, -36),
	Position = UDim2.new(0, 0, 0, 36),
	BackgroundTransparency = 1
}, panel)

local toggleFlyBtn = new("TextButton", {
	Size = UDim2.new(1, -20, 0, 45),
	Position = UDim2.new(0, 10, 0, 10),
	TextScaled = true,
	Text = "BẬT BAY"
}, content)

-- Row chạy
local walkLabel = new("TextLabel", {
	Size = UDim2.new(0.55, -15, 0, 35),
	Position = UDim2.new(0, 10, 0, 65),
	BackgroundTransparency = 1,
	TextScaled = true,
	TextXAlignment = Enum.TextXAlignment.Left,
	Text = ("CHẠY: %d"):format(walkSpeed)
}, content)

local walkMinus = new("TextButton", {
	Size = UDim2.new(0, 45, 0, 35),
	Position = UDim2.new(0.55, 0, 0, 65),
	TextScaled = true,
	Text = "-"
}, content)

local walkPlus = new("TextButton", {
	Size = UDim2.new(0, 45, 0, 35),
	Position = UDim2.new(0.55, 50, 0, 65),
	TextScaled = true,
	Text = "+"
}, content)

-- Row bay
local flyLabel = new("TextLabel", {
	Size = UDim2.new(0.55, -15, 0, 35),
	Position = UDim2.new(0, 10, 0, 105),
	BackgroundTransparency = 1,
	TextScaled = true,
	TextXAlignment = Enum.TextXAlignment.Left,
	Text = ("BAY: %d"):format(flySpeed)
}, content)

local flyMinus = new("TextButton", {
	Size = UDim2.new(0, 45, 0, 35),
	Position = UDim2.new(0.55, 0, 0, 105),
	TextScaled = true,
	Text = "-"
}, content)

local flyPlus = new("TextButton", {
	Size = UDim2.new(0, 45, 0, 35),
	Position = UDim2.new(0.55, 50, 0, 105),
	TextScaled = true,
	Text = "+"
}, content)

local hint = new("TextLabel", {
	Size = UDim2.new(1, -20, 0, 30),
	Position = UDim2.new(0, 10, 0, 145),
	BackgroundTransparency = 1,
	TextScaled = true,
	Text = "WASD bay • Space lên • Ctrl xuống"
}, content)

-- ===== APPLY WALK SPEED =====
local function applyWalkSpeed()
	local hum = getHumanoid()
	hum.WalkSpeed = walkSpeed
	walkLabel.Text = ("CHẠY: %d"):format(walkSpeed)
end

-- ===== BUTTON EVENTS =====
toggleFlyBtn.MouseButton1Click:Connect(function()
	if flying then
		stopFly()
		toggleFlyBtn.Text = "BẬT BAY"
	else
		startFly()
		toggleFlyBtn.Text = "TẮT BAY"
	end
end)

walkMinus.MouseButton1Click:Connect(function()
	walkSpeed = clamp(walkSpeed - WALK_STEP, WALK_MIN, WALK_MAX)
	applyWalkSpeed()
end)

walkPlus.MouseButton1Click:Connect(function()
	walkSpeed = clamp(walkSpeed + WALK_STEP, WALK_MIN, WALK_MAX)
	applyWalkSpeed()
end)

flyMinus.MouseButton1Click:Connect(function()
	flySpeed = clamp(flySpeed - FLY_STEP, FLY_MIN, FLY_MAX)
	flyLabel.Text = ("BAY: %d"):format(flySpeed)
end)

flyPlus.MouseButton1Click:Connect(function()
	flySpeed = clamp(flySpeed + FLY_STEP, FLY_MIN, FLY_MAX)
	flyLabel.Text = ("BAY: %d"):format(flySpeed)
end)

-- ===== HIDE / SHOW =====
local minimized = false
local fullSize = panel.Size
local miniSize = UDim2.new(0, 350, 0, 36)

local function setMinimized(state)
	minimized = state
	if minimized then
		content.Visible = false
		panel.Size = miniSize
		btnHide.Text = "▢" -- mở lại
		title.Text = "FLY + SPEED (ĐÃ ẨN)"
	else
		content.Visible = true
		panel.Size = fullSize
		btnHide.Text = "-"
		title.Text = "FLY + SPEED"
	end
end

btnHide.MouseButton1Click:Connect(function()
	setMinimized(not minimized)
end)

-- Close: xoá GUI + tắt bay luôn
btnClose.MouseButton1Click:Connect(function()
	stopFly()
	gui:Destroy()
end)

-- Respawn: tắt bay, set lại speed
player.CharacterAdded:Connect(function()
	stopFly()
	if toggleFlyBtn and toggleFlyBtn.Parent then
		toggleFlyBtn.Text = "BẬT BAY"
	end
	task.wait(0.1)
	applyWalkSpeed()
end)

applyWalkSpeed()

-- StarterPlayerScripts/AutoPanel_V3_FlySpeed_AntiFall_Heal_Tele_Invis.client.lua

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local function new(inst, props, parent)
	local obj = Instance.new(inst)
	for k, v in pairs(props) do obj[k] = v end
	obj.Parent = parent
	return obj
end

local function getChar() return player.Character or player.CharacterAdded:Wait() end
local function getHumanoid() return getChar():WaitForChild("Humanoid") end
local function getHRP() return getChar():WaitForChild("HumanoidRootPart") end
local function clamp(n,a,b) return math.max(a, math.min(b,n)) end

local WALK_MIN, WALK_MAX, WALK_STEP = 16, 200, 10
local FLY_MIN,  FLY_MAX,  FLY_STEP  = 20, 200, 10
local walkSpeed, flySpeed = 16, 60

local function findSpawnCFrame()
	local sp = Workspace:FindFirstChildWhichIsA("SpawnLocation", true)
	if sp and sp:IsA("BasePart") then return sp.CFrame + Vector3.new(0, 6, 0) end
	local byName = Workspace:FindFirstChild("Spawn", true) or Workspace:FindFirstChild("SpawnPoint", true)
	if byName and byName:IsA("BasePart") then return byName.CFrame + Vector3.new(0, 6, 0) end
	return CFrame.new(0, 50, 0)
end

-- ✅ Xoá GUI cũ nếu có
local old = playerGui:FindFirstChild("AutoPanel_V3")
if old then old:Destroy() end

local gui = new("ScreenGui", {Name="AutoPanel_V3", ResetOnSpawn=false}, playerGui)

local panel = new("Frame", {
	Name="Panel",
	Size=UDim2.new(0, 360, 0, 470), -- cao hơn để có nút tàng hình
	Position=UDim2.new(0, 20, 0, 20),
	BackgroundTransparency=0.15
}, gui)

new("TextLabel", {
	Size=UDim2.new(1, -20, 0, 28),
	Position=UDim2.new(0, 10, 0, 8),
	BackgroundTransparency=1,
	TextScaled=true,
	Text="FLY + SPEED + ANTI NGÃ + HEAL + TELE + INVIS"
}, panel)

local toggleFlyBtn = new("TextButton", {
	Size=UDim2.new(1, -20, 0, 44),
	Position=UDim2.new(0, 10, 0, 44),
	TextScaled=true,
	Text="BẬT BAY"
}, panel)

local walkLabel = new("TextLabel", {
	Size=UDim2.new(0.55, -15, 0, 34),
	Position=UDim2.new(0, 10, 0, 96),
	BackgroundTransparency=1,
	TextScaled=true,
	TextXAlignment=Enum.TextXAlignment.Left,
	Text=("CHẠY: %d"):format(walkSpeed)
}, panel)

local walkMinus = new("TextButton", {
	Size=UDim2.new(0, 45, 0, 34),
	Position=UDim2.new(0.55, 0, 0, 96),
	TextScaled=true,
	Text="-"
}, panel)

local walkPlus = new("TextButton", {
	Size=UDim2.new(0, 45, 0, 34),
	Position=UDim2.new(0.55, 50, 0, 96),
	TextScaled=true,
	Text="+"
}, panel)

local flyLabel = new("TextLabel", {
	Size=UDim2.new(0.55, -15, 0, 34),
	Position=UDim2.new(0, 10, 0, 136),
	BackgroundTransparency=1,
	TextScaled=true,
	TextXAlignment=Enum.TextXAlignment.Left,
	Text=("BAY: %d"):format(flySpeed)
}, panel)

local flyMinus = new("TextButton", {
	Size=UDim2.new(0, 45, 0, 34),
	Position=UDim2.new(0.55, 0, 0, 136),
	TextScaled=true,
	Text="-"
}, panel)

local flyPlus = new("TextButton", {
	Size=UDim2.new(0, 45, 0, 34),
	Position=UDim2.new(0.55, 50, 0, 136),
	TextScaled=true,
	Text="+"
}, panel)

local antiFallBtn = new("TextButton", {
	Size=UDim2.new(1, -20, 0, 40),
	Position=UDim2.new(0, 10, 0, 180),
	TextScaled=true,
	Text="ANTI NGÃ: TẮT"
}, panel)

local healBtn = new("TextButton", {
	Size=UDim2.new(1, -20, 0, 40),
	Position=UDim2.new(0, 10, 0, 225),
	TextScaled=true,
	Text="HỒI MÁU (MAX)"
}, panel)

local teleBtn = new("TextButton", {
	Size=UDim2.new(1, -20, 0, 40),
	Position=UDim2.new(0, 10, 0, 270),
	TextScaled=true,
	Text="TELE VỀ SPAWN ✅"
}, panel)

-- ✅ NÚT TÀNG HÌNH
local invisBtn = new("TextButton", {
	Size=UDim2.new(1, -20, 0, 40),
	Position=UDim2.new(0, 10, 0, 315),
	TextScaled=true,
	Text="TÀNG HÌNH: TẮT"
}, panel)

new("TextLabel", {
	Size=UDim2.new(1, -20, 0, 110),
	Position=UDim2.new(0, 10, 0, 360),
	BackgroundTransparency=1,
	TextScaled=true,
	Text="Bay: WASD • Space lên • Ctrl xuống\nP: ẩn/hiện panel"
}, panel)

-- ===== WALK SPEED APPLY =====
local function applyWalkSpeed()
	local hum = getHumanoid()
	hum.WalkSpeed = walkSpeed
	walkLabel.Text = ("CHẠY: %d"):format(walkSpeed)
end

-- ===== FLY =====
local flying = false
local bv, bg, flyConn

local function stopFly()
	if not flying then return end
	flying = false
	toggleFlyBtn.Text = "BẬT BAY"
	if flyConn then flyConn:Disconnect() flyConn = nil end
	if bv then bv:Destroy() bv = nil end
	if bg then bg:Destroy() bg = nil end
end

local function startFly()
	if flying then return end
	flying = true
	toggleFlyBtn.Text = "TẮT BAY"
	local hrp = getHRP()

	bv = Instance.new("BodyVelocity")
	bv.MaxForce = Vector3.new(1e9, 1e9, 1e9)
	bv.Velocity = Vector3.zero
	bv.Parent = hrp

	bg = Instance.new("BodyGyro")
	bg.MaxTorque = Vector3.new(1e9, 1e9, 1e9)
	bg.P = 9e4
	bg.CFrame = hrp.CFrame
	bg.Parent = hrp

	flyConn = RunService.RenderStepped:Connect(function()
		local cam = workspace.CurrentCamera
		if not cam or not hrp then return end

		local move = Vector3.zero
		if UserInputService:IsKeyDown(Enum.KeyCode.W) then move += cam.CFrame.LookVector end
		if UserInputService:IsKeyDown(Enum.KeyCode.S) then move -= cam.CFrame.LookVector end
		if UserInputService:IsKeyDown(Enum.KeyCode.A) then move -= cam.CFrame.RightVector end
		if UserInputService:IsKeyDown(Enum.KeyCode.D) then move += cam.CFrame.RightVector end
		if UserInputService:IsKeyDown(Enum.KeyCode.Space) then move += Vector3.new(0, 1, 0) end
		if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then move -= Vector3.new(0, 1, 0) end

		if move.Magnitude > 0 then
			move = move.Unit * flySpeed
		end

		bv.Velocity = move
		bg.CFrame = cam.CFrame
	end)
end

-- ===== ANTI FALL =====
local antiFall = false
local antiStateConn, antiHeartbeatConn

local function applyAntiFall(state)
	antiFall = state
	antiFallBtn.Text = antiFall and "ANTI NGÃ: BẬT" or "ANTI NGÃ: TẮT"

	if antiStateConn then antiStateConn:Disconnect() antiStateConn = nil end
	if antiHeartbeatConn then antiHeartbeatConn:Disconnect() antiHeartbeatConn = nil end

	local hum = getHumanoid()
	hum.PlatformStand = false

	if not antiFall then return end

	antiStateConn = hum.StateChanged:Connect(function(_, newState)
		if not antiFall then return end
		if newState == Enum.HumanoidStateType.FallingDown
			or newState == Enum.HumanoidStateType.Ragdoll
			or newState == Enum.HumanoidStateType.Physics then
			pcall(function()
				hum:ChangeState(Enum.HumanoidStateType.GettingUp)
				hum:ChangeState(Enum.HumanoidStateType.Running)
			end)
		end
	end)

	antiHeartbeatConn = RunService.Heartbeat:Connect(function()
		if antiFall and hum and hum.Parent and hum.PlatformStand then
			hum.PlatformStand = false
		end
	end)
end

-- ===== INVIS (chỉ ẩn nhân vật của mình) =====
local invisible = false
local saved = {} -- [Instance] = {Transparency=?, LocalTransparencyModifier=?}

local function setPartInvis(part, on)
	if not part:IsA("BasePart") then return end
	if on then
		if not saved[part] then
			saved[part] = {
				T = part.Transparency,
				LTM = part.LocalTransparencyModifier
			}
		end
		part.LocalTransparencyModifier = 1
	else
		local s = saved[part]
		if s then
			part.LocalTransparencyModifier = s.LTM
		else
			part.LocalTransparencyModifier = 0
		end
	end
end

local function applyInvis(state)
	invisible = state
	invisBtn.Text = invisible and "TÀNG HÌNH: BẬT" or "TÀNG HÌNH: TẮT"

	local char = getChar()

	-- Ẩn/hiện tất cả BasePart trong character (kể cả accessory handle)
	for _, d in ipairs(char:GetDescendants()) do
		if d:IsA("BasePart") then
			setPartInvis(d, invisible)
		end
	end

	-- Nếu có Highlight (tuỳ game) thì cũng tắt
	local hl = char:FindFirstChildOfClass("Highlight")
	if hl then
		hl.Enabled = not invisible
	end
end

-- ===== EVENTS =====
toggleFlyBtn.MouseButton1Click:Connect(function()
	if flying then stopFly() else startFly() end
end)

walkMinus.MouseButton1Click:Connect(function()
	walkSpeed = clamp(walkSpeed - WALK_STEP, WALK_MIN, WALK_MAX)
	applyWalkSpeed()
end)

walkPlus.MouseButton1Click:Connect(function()
	walkSpeed = clamp(walkSpeed + WALK_STEP, WALK_MIN, WALK_MAX)
	applyWalkSpeed()
end)

flyMinus.MouseButton1Click:Connect(function()
	flySpeed = clamp(flySpeed - FLY_STEP, FLY_MIN, FLY_MAX)
	flyLabel.Text = ("BAY: %d"):format(flySpeed)
end)

flyPlus.MouseButton1Click:Connect(function()
	flySpeed = clamp(flySpeed + FLY_STEP, FLY_MIN, FLY_MAX)
	flyLabel.Text = ("BAY: %d"):format(flySpeed)
end)

antiFallBtn.MouseButton1Click:Connect(function()
	applyAntiFall(not antiFall)
end)

healBtn.MouseButton1Click:Connect(function()
	local hum = getHumanoid()
	hum.Health = hum.MaxHealth
end)

teleBtn.MouseButton1Click:Connect(function()
	stopFly()
	local hrp = getHRP()
	hrp.CFrame = findSpawnCFrame()
end)

invisBtn.MouseButton1Click:Connect(function()
	applyInvis(not invisible)
end)

-- Hotkey P ẩn/hiện panel
UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.KeyCode == Enum.KeyCode.P then
		panel.Visible = not panel.Visible
	end
end)

player.CharacterAdded:Connect(function()
	stopFly()
	task.wait(0.1)
	applyWalkSpeed()
	if antiFall then applyAntiFall(true) end
	if invisible then
		task.wait(0.2)
		applyInvis(true)
	end
end)

applyWalkSpeed()

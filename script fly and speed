-- StarterPlayerScripts/AutoPanel_V12_AllInOne_SAFE_Lift50_TeleSpawn_Down10.client.lua
-- Tele: lên 50 (tại chỗ) -> về spawn (safe) -> xuống 10 (tìm chỗ trống)
-- Fly + speed (max 200) + Anti ngã + Heal + Tele + Unstuck + Tàng hình (local)
-- GUI có _ và X, phím P ẩn/hiện
-- Không noclip.

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- ===== CONFIG =====
local WALK_MIN, WALK_MAX, WALK_STEP = 16, 200, 10
local FLY_MIN,  FLY_MAX,  FLY_STEP  = 20, 200, 10
local walkSpeed, flySpeed = 16, 60

local LIFT_UP_STUDS = 50
local DOWN_STUDS    = 10
local STEP_DELAY    = 0.10
local UNSTUCK_UP_STUDS = 25

-- ===== HELPERS =====
local function new(inst, props, parent)
	local obj = Instance.new(inst)
	for k, v in pairs(props) do obj[k] = v end
	obj.Parent = parent
	return obj
end

local function clamp(n,a,b) return math.max(a, math.min(b,n)) end
local function getChar() return player.Character or player.CharacterAdded:Wait() end
local function getHumanoid() return getChar():WaitForChild("Humanoid") end
local function getHRP() return getChar():WaitForChild("HumanoidRootPart") end

local function findSpawnCFrame()
	local sp = Workspace:FindFirstChildWhichIsA("SpawnLocation", true)
	if sp and sp:IsA("BasePart") then return sp.CFrame + Vector3.new(0, 6, 0) end
	local byName = Workspace:FindFirstChild("Spawn", true) or Workspace:FindFirstChild("SpawnPoint", true)
	if byName and byName:IsA("BasePart") then return byName.CFrame + Vector3.new(0, 6, 0) end
	return CFrame.new(0, 50, 0)
end

-- Anti-kẹt: thử đặt ở nhiều độ cao quanh spawn để tránh mắc trong tường/sàn
local function safeSetCFrame(hrp, targetCFrame)
	if not hrp or not hrp.Parent then return end
	local rotOnly = targetCFrame - targetCFrame.Position
	local basePos = targetCFrame.Position

	hrp.CFrame = targetCFrame
	task.wait()

	for i = 1, 18 do
		if not hrp or not hrp.Parent then return end
		local tryPos = basePos + Vector3.new(0, i * 3, 0)
		hrp.CFrame = CFrame.new(tryPos) * rotOnly
		task.wait()
	end
end

-- Tìm vị trí trống gần 1 điểm (để xuống -10 không bị kẹt)
local function findFreePosNear(pos, char)
	local params = OverlapParams.new()
	params.FilterType = Enum.RaycastFilterType.Exclude
	params.FilterDescendantsInstances = {char}

	local function isFree(p)
		local parts = Workspace:GetPartBoundsInBox(CFrame.new(p), Vector3.new(4, 6, 4), params)
		return #parts == 0
	end

	local offsets = {
		Vector3.new(0,0,0),
		Vector3.new(2,0,0), Vector3.new(-2,0,0),
		Vector3.new(0,0,2), Vector3.new(0,0,-2),
		Vector3.new(3,0,3), Vector3.new(-3,0,3),
		Vector3.new(3,0,-3), Vector3.new(-3,0,-3),
	}

	for dy = 0, 12 do
		for _, off in ipairs(offsets) do
			local p = pos + off + Vector3.new(0, -dy, 0)
			if isFree(p) then return p end
		end
	end

	return pos
end

-- ===== CLEAN OLD GUI =====
local old = playerGui:FindFirstChild("AutoPanel_V12")
if old then old:Destroy() end

-- ===== GUI =====
local gui = new("ScreenGui", {Name="AutoPanel_V12", ResetOnSpawn=false}, playerGui)
local panel = new("Frame", {Size=UDim2.new(0,370,0,560), Position=UDim2.new(0,20,0,20), BackgroundTransparency=0.15}, gui)
local topBar = new("Frame", {Size=UDim2.new(1,0,0,36), BackgroundTransparency=0.25}, panel)

local title = new("TextLabel", {
	Size=UDim2.new(1,-110,1,0), Position=UDim2.new(0,10,0,0),
	BackgroundTransparency=1, TextScaled=true, TextXAlignment=Enum.TextXAlignment.Left,
	Text="ADMIN PANEL (LIFT50 → SPAWN → DOWN10)"
}, topBar)

local btnMin = new("TextButton", {Size=UDim2.new(0,45,0,26), Position=UDim2.new(1,-100,0.5,-13), TextScaled=true, Text="_"}, topBar)
local btnClose = new("TextButton", {Size=UDim2.new(0,45,0,26), Position=UDim2.new(1,-50,0.5,-13), TextScaled=true, Text="X"}, topBar)

local content = new("Frame", {Size=UDim2.new(1,0,1,-36), Position=UDim2.new(0,0,0,36), BackgroundTransparency=1}, panel)

local y = 10
local function addButton(text, height)
	local b = new("TextButton", {Size=UDim2.new(1,-20,0,height), Position=UDim2.new(0,10,0,y), TextScaled=true, Text=text}, content)
	y += height + 8
	return b
end

local function addRowLabel(labelText)
	local lbl = new("TextLabel", {Size=UDim2.new(0.55,-15,0,34), Position=UDim2.new(0,10,0,y), BackgroundTransparency=1, TextScaled=true, TextXAlignment=Enum.TextXAlignment.Left, Text=labelText}, content)
	local minus = new("TextButton", {Size=UDim2.new(0,45,0,34), Position=UDim2.new(0.55,0,0,y), TextScaled=true, Text="-"}, content)
	local plus  = new("TextButton", {Size=UDim2.new(0,45,0,34), Position=UDim2.new(0.55,50,0,y), TextScaled=true, Text="+"}, content)
	y += 34 + 8
	return lbl, minus, plus
end

-- UI
local flyBtn = addButton("BẬT BAY", 44)
local walkLabel, walkMinus, walkPlus = addRowLabel(("CHẠY: %d"):format(walkSpeed))
local flyLabel,  flyMinus,  flyPlus  = addRowLabel(("BAY: %d"):format(flySpeed))
local antiFallBtn = addButton("ANTI NGÃ: TẮT", 40)
local healBtn     = addButton("HỒI MÁU (MAX)", 40)
local teleBtn     = addButton("TELE: LÊN 50 → SPAWN → XUỐNG 10", 40)
local unstuckBtn  = addButton(("THOÁT KẸT (+%d)"):format(UNSTUCK_UP_STUDS), 40)
local invisBtn    = addButton("TÀNG HÌNH: TẮT", 40)

new("TextLabel", {Size=UDim2.new(1,-20,0,80), Position=UDim2.new(0,10,0,y), BackgroundTransparency=1, TextScaled=true,
	Text="P: ẩn/hiện • _ : thu gọn • X: đóng\nBay: WASD • Space lên • Ctrl xuống"
}, content)

-- ===== WALK SPEED =====
local function applyWalkSpeed()
	local hum = getHumanoid()
	hum.WalkSpeed = walkSpeed
	walkLabel.Text = ("CHẠY: %d"):format(walkSpeed)
end

-- ===== FLY =====
local flying = false
local bv, bg, flyConn

local function stopFly()
	if not flying then return end
	flying = false
	flyBtn.Text = "BẬT BAY"
	if flyConn then flyConn:Disconnect() flyConn = nil end
	if bv then bv:Destroy() bv = nil end
	if bg then bg:Destroy() bg = nil end
end

local function startFly()
	if flying then return end
	flying = true
	flyBtn.Text = "TẮT BAY"
	local hrp = getHRP()

	bv = Instance.new("BodyVelocity")
	bv.MaxForce = Vector3.new(1e9, 1e9, 1e9)
	bv.Velocity = Vector3.zero
	bv.Parent = hrp

	bg = Instance.new("BodyGyro")
	bg.MaxTorque = Vector3.new(1e9, 1e9, 1e9)
	bg.P = 9e4
	bg.CFrame = hrp.CFrame
	bg.Parent = hrp

	flyConn = RunService.RenderStepped:Connect(function()
		local cam = workspace.CurrentCamera
		if not cam or not hrp then return end

		local move = Vector3.zero
		if UserInputService:IsKeyDown(Enum.KeyCode.W) then move += cam.CFrame.LookVector end
		if UserInputService:IsKeyDown(Enum.KeyCode.S) then move -= cam.CFrame.LookVector end
		if UserInputService:IsKeyDown(Enum.KeyCode.A) then move -= cam.CFrame.RightVector end
		if UserInputService:IsKeyDown(Enum.KeyCode.D) then move += cam.CFrame.RightVector end
		if UserInputService:IsKeyDown(Enum.KeyCode.Space) then move += Vector3.new(0,1,0) end
		if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then move -= Vector3.new(0,1,0) end

		if move.Magnitude > 0 then move = move.Unit * flySpeed end
		bv.Velocity = move
		bg.CFrame = cam.CFrame
	end)
end

-- ===== ANTI FALL =====
local antiFall = false
local antiStateConn, antiHeartbeatConn

local function applyAntiFall(state)
	antiFall = state
	antiFallBtn.Text = antiFall and "ANTI NGÃ: BẬT" or "ANTI NGÃ: TẮT"

	if antiStateConn then antiStateConn:Disconnect() antiStateConn = nil end
	if antiHeartbeatConn then antiHeartbeatConn:Disconnect() antiHeartbeatConn = nil end

	local hum = getHumanoid()
	hum.PlatformStand = false
	if not antiFall then return end

	antiStateConn = hum.StateChanged:Connect(function(_, newState)
		if not antiFall then return end
		if newState == Enum.HumanoidStateType.FallingDown
			or newState == Enum.HumanoidStateType.Ragdoll
			or newState == Enum.HumanoidStateType.Physics then
			pcall(function()
				hum:ChangeState(Enum.HumanoidStateType.GettingUp)
				hum:ChangeState(Enum.HumanoidStateType.Running)
			end)
		end
	end)

	antiHeartbeatConn = RunService.Heartbeat:Connect(function()
		local hum2 = getHumanoid()
		if antiFall and hum2 and hum2.Parent and hum2.PlatformStand then
			hum2.PlatformStand = false
		end
	end)
end

-- ===== INVIS (local) =====
local invisible = false
local savedLTM = {}

local function setInvis(state)
	invisible = state
	invisBtn.Text = invisible and "TÀNG HÌNH: BẬT" or "TÀNG HÌNH: TẮT"
	local char = getChar()
	for _, d in ipairs(char:GetDescendants()) do
		if d:IsA("BasePart") then
			if state then
				if savedLTM[d] == nil then savedLTM[d] = d.LocalTransparencyModifier end
				d.LocalTransparencyModifier = 1
			else
				d.LocalTransparencyModifier = savedLTM[d] or 0
			end
		end
	end
end

-- ===== TELE: LIFT 50 -> SPAWN -> DOWN 10 =====
local function teleLift50SpawnDown()
	stopFly()
	local hrp = getHRP()
	local char = getChar()

	-- B1: lên 50 tại chỗ (thoát kẹt)
	do
		local rot = hrp.CFrame - hrp.CFrame.Position
		hrp.AssemblyLinearVelocity = Vector3.zero
		hrp.AssemblyAngularVelocity = Vector3.zero
		hrp.CFrame = CFrame.new(hrp.Position + Vector3.new(0, LIFT_UP_STUDS, 0)) * rot
	end

	-- B2: về spawn (safe)
	task.delay(STEP_DELAY, function()
		if not hrp or not hrp.Parent then return end
		local base = findSpawnCFrame()
		safeSetCFrame(hrp, base)

		-- B3: xuống 10 (tìm chỗ trống gần đó)
		task.delay(STEP_DELAY, function()
			if not hrp or not hrp.Parent then return end
			local rot = hrp.CFrame - hrp.CFrame.Position
			local targetDown = hrp.Position + Vector3.new(0, -DOWN_STUDS, 0)
			local freePos = findFreePosNear(targetDown, char)
			hrp.CFrame = CFrame.new(freePos) * rot
		end)
	end)
end

-- ===== UNSTUCK =====
local function unstuck()
	stopFly()
	local hrp = getHRP()
	local rot = hrp.CFrame - hrp.CFrame.Position
	hrp.AssemblyLinearVelocity = Vector3.zero
	hrp.AssemblyAngularVelocity = Vector3.zero
	hrp.CFrame = CFrame.new(hrp.Position + Vector3.new(0, UNSTUCK_UP_STUDS, 0)) * rot
end

-- ===== EVENTS =====
flyBtn.MouseButton1Click:Connect(function() if flying then stopFly() else startFly() end end)

walkMinus.MouseButton1Click:Connect(function()
	walkSpeed = clamp(walkSpeed - WALK_STEP, WALK_MIN, WALK_MAX)
	applyWalkSpeed()
end)

walkPlus.MouseButton1Click:Connect(function()
	walkSpeed = clamp(walkSpeed + WALK_STEP, WALK_MIN, WALK_MAX)
	applyWalkSpeed()
end)

flyMinus.MouseButton1Click:Connect(function()
	flySpeed = clamp(flySpeed - FLY_STEP, FLY_MIN, FLY_MAX)
	flyLabel.Text = ("BAY: %d"):format(flySpeed)
end)

flyPlus.MouseButton1Click:Connect(function()
	flySpeed = clamp(flySpeed + FLY_STEP, FLY_MIN, FLY_MAX)
	flyLabel.Text = ("BAY: %d"):format(flySpeed)
end)

antiFallBtn.MouseButton1Click:Connect(function() applyAntiFall(not antiFall) end)

healBtn.MouseButton1Click:Connect(function()
	local hum = getHumanoid()
	hum.Health = hum.MaxHealth
end)

teleBtn.MouseButton1Click:Connect(teleLift50SpawnDown)
unstuckBtn.MouseButton1Click:Connect(unstuck)
invisBtn.MouseButton1Click:Connect(function() setInvis(not invisible) end)

-- Minimize / Close
local minimized = false
local fullSize = panel.Size
local miniSize = UDim2.new(0, 370, 0, 36)

btnMin.MouseButton1Click:Connect(function()
	minimized = not minimized
	if minimized then
		content.Visible = false
		panel.Size = miniSize
		btnMin.Text = "▢"
		title.Text = "ADMIN PANEL (ĐÃ ẨN)"
	else
		content.Visible = true
		panel.Size = fullSize
		btnMin.Text = "_"
		title.Text = "ADMIN PANEL (LIFT50 → SPAWN → DOWN10)"
	end
end)

btnClose.MouseButton1Click:Connect(function()
	stopFly()
	if antiFall then applyAntiFall(false) end
	gui:Destroy()
end)

-- Hotkey P
UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.KeyCode == Enum.KeyCode.P then
		panel.Visible = not panel.Visible
	end
end)

-- Respawn
player.CharacterAdded:Connect(function()
	stopFly()
	task.wait(0.1)
	applyWalkSpeed()
	if antiFall then applyAntiFall(true) end
	if invisible then task.wait(0.2) setInvis(true) end
end)

applyWalkSpeed()

-- StarterPlayerScripts/OneScript_FULL_AdminSafe.client.lua
-- 1 LocalScript: Key -> 2 GUI (Jump + Fly/Speed/Anti) + AntiRagdoll + Chống Ngã + Ghost Mode + Training Mode
-- + ADMIN TOOLS an toàn (chỉ tác động lên CHÍNH ADMIN): TP Spawn/SafeZone, Heal, Reset, Gravity thấp.
-- Không có kick/ban, không miễn phí gamepass, không anti-kick.

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local function notify(title, text, seconds)
	pcall(function()
		StarterGui:SetCore("SendNotification", {
			Title = title or "INFO",
			Text = text or "",
			Duration = seconds or 3
		})
	end)
end

-- ===== KEY =====
local KEY_OK = "HUNGSCRIPT-3456"

-- ===== ADMIN (chỉ để hiện ADMIN TOOLS an toàn) =====
local ADMIN_USERIDS = {
	-- 123456789, -- thay bằng UserId của bạn
}

local function isAdmin()
	for _, id in ipairs(ADMIN_USERIDS) do
		if player.UserId == id then return true end
	end
	return false
end

-- ===== LIMITS =====
local WALK_MIN, WALK_MAX, WALK_STEP = 16, 200, 10
local FLY_MIN,  FLY_MAX,  FLY_STEP  = 20, 200, 10

local FIN_MAX_LIMIT = 10
local FIN_BOOST_LIMIT = 200

local function clamp(n,a,b) return math.max(a, math.min(b,n)) end
local function getChar() return player.Character or player.CharacterAdded:Wait() end
local function getHumanoid() return getChar():WaitForChild("Humanoid") end
local function getHRP() return getChar():WaitForChild("HumanoidRootPart") end

local function mk(inst, props, parent)
	local o = Instance.new(inst)
	for k,v in pairs(props) do o[k]=v end
	o.Parent = parent
	return o
end

-- Clean old GUI
local old = playerGui:FindFirstChild("OneScriptGUI")
if old then old:Destroy() end
local gui = mk("ScreenGui", {Name="OneScriptGUI", ResetOnSpawn=false}, playerGui)

-- ===== STATE =====
local access = false

-- Fly
local flyEnabled = false
local walkSpeed = 16
local flySpeed = 60
local bv, bg, flyConn

-- Jump
local infJump = false
local finEnabled = false
local finMaxAir = 2
local finBoost = 55
local usedAir = 0
local lastSpaceAt = 0

-- Anti ragdoll (Motor6D re-enable)
local antiRagdoll = false
local antiRagConn

-- Anti fall (chống ngã)
local antiFall = false
local antiFallConn

-- Ghost mode
local ghostEnabled = false
local ghostConn
local lastPos
local stuckTime = 0

-- Training mode (SafeZone)
local trainingEnabled = false
local trainingConn

local function isGrounded(hum)
	local st = hum:GetState()
	return st == Enum.HumanoidStateType.Running
		or st == Enum.HumanoidStateType.RunningNoPhysics
		or st == Enum.HumanoidStateType.Landed
end

local function applyWalkSpeed()
	getHumanoid().WalkSpeed = walkSpeed
end

-- ===== Fly =====
local function stopFly()
	if not flyEnabled then return end
	flyEnabled = false
	if flyConn then flyConn:Disconnect() flyConn = nil end
	if bv then bv:Destroy() bv = nil end
	if bg then bg:Destroy() bg = nil end
end

local function startFly()
	if flyEnabled then return end
	flyEnabled = true

	local hrp = getHRP()
	bv = Instance.new("BodyVelocity")
	bv.MaxForce = Vector3.new(1e9, 1e9, 1e9)
	bv.Velocity = Vector3.zero
	bv.Parent = hrp

	bg = Instance.new("BodyGyro")
	bg.MaxTorque = Vector3.new(1e9, 1e9, 1e9)
	bg.P = 9e4
	bg.CFrame = hrp.CFrame
	bg.Parent = hrp

	flyConn = RunService.RenderStepped:Connect(function()
		local cam = workspace.CurrentCamera
		if not cam or not hrp then return end

		local move = Vector3.zero
		if UserInputService:IsKeyDown(Enum.KeyCode.W) then move += cam.CFrame.LookVector end
		if UserInputService:IsKeyDown(Enum.KeyCode.S) then move -= cam.CFrame.LookVector end
		if UserInputService:IsKeyDown(Enum.KeyCode.A) then move -= cam.CFrame.RightVector end
		if UserInputService:IsKeyDown(Enum.KeyCode.D) then move += cam.CFrame.RightVector end
		if UserInputService:IsKeyDown(Enum.KeyCode.Space) then move += Vector3.new(0,1,0) end
		if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then move -= Vector3.new(0,1,0) end

		if move.Magnitude > 0 then move = move.Unit * flySpeed end
		bv.Velocity = move
		bg.CFrame = cam.CFrame
	end)
end

-- ===== Ghost =====
local function GhostStep(studs)
	studs = studs or 6
	local char = player.Character
	if not char then return end
	local hrp = char:FindFirstChild("HumanoidRootPart")
	if not hrp then return end
	local cam = workspace.CurrentCamera
	if not cam then return end

	local dir = cam.CFrame.LookVector
	local flat = Vector3.new(dir.X, 0, dir.Z)
	if flat.Magnitude < 0.01 then return end
	flat = flat.Unit

	local start = hrp.Position + Vector3.new(0, 2, 0)
	local target = hrp.Position + flat * studs + Vector3.new(0, 2, 0)

	local params = RaycastParams.new()
	params.FilterType = Enum.RaycastFilterType.Exclude
	params.FilterDescendantsInstances = {char}

	local hit = workspace:Raycast(start, (target - start), params)
	if hit then target = hit.Position - flat * 1 end

	local rot = hrp.CFrame - hrp.Position
	hrp.AssemblyLinearVelocity = Vector3.zero
	hrp.CFrame = CFrame.new(target) * rot
end

local function setGhostMode(state)
	ghostEnabled = state
	if ghostConn then ghostConn:Disconnect() ghostConn = nil end
	lastPos, stuckTime = nil, 0
	if not ghostEnabled then return end

	ghostConn = RunService.Heartbeat:Connect(function(dt)
		local char = player.Character
		if not char then return end
		local hrp = char:FindFirstChild("HumanoidRootPart")
		local hum = char:FindFirstChildOfClass("Humanoid")
		if not hrp or not hum then return end

		if flyEnabled then
			lastPos = hrp.Position
			stuckTime = 0
			return
		end

		local movingKey =
			UserInputService:IsKeyDown(Enum.KeyCode.W) or
			UserInputService:IsKeyDown(Enum.KeyCode.A) or
			UserInputService:IsKeyDown(Enum.KeyCode.S) or
			UserInputService:IsKeyDown(Enum.KeyCode.D)

		if not movingKey then
			lastPos = hrp.Position
			stuckTime = 0
			return
		end

		if not lastPos then lastPos = hrp.Position return end

		local moved = (hrp.Position - lastPos).Magnitude
		lastPos = hrp.Position

		if moved < 0.05 and hum.MoveDirection.Magnitude > 0.05 then
			stuckTime += dt
			if stuckTime >= 0.35 then
				stuckTime = 0
				GhostStep(4)
			end
		else
			stuckTime = 0
		end
	end)
end

-- ===== Training (SafeZone) =====
local function inSafeZone()
	local zone = workspace:FindFirstChild("SafeZone")
	if not zone or not zone:IsA("BasePart") then return false end
	local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
	if not hrp then return false end
	local lp = zone.CFrame:PointToObjectSpace(hrp.Position)
	return math.abs(lp.X) <= zone.Size.X/2
		and math.abs(lp.Y) <= zone.Size.Y/2
		and math.abs(lp.Z) <= zone.Size.Z/2
end

local function setTrainingMode(state)
	trainingEnabled = state
	if trainingConn then trainingConn:Disconnect() trainingConn = nil end
	if not trainingEnabled then return end

	trainingConn = RunService.Heartbeat:Connect(function()
		local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
		if not hum then return end
		if inSafeZone() and hum.Health < hum.MaxHealth then
			hum.Health = hum.MaxHealth
		end
	end)
end

-- ===== Anti Ragdoll (Motor6D fix) =====
local function setAntiRagdoll(state)
	antiRagdoll = state
	if antiRagConn then antiRagConn:Disconnect() antiRagConn = nil end
	if not antiRagdoll then return end

	antiRagConn = RunService.Heartbeat:Connect(function()
		local char = player.Character
		if not char then return end
		local hum = char:FindFirstChildOfClass("Humanoid")
		if not hum then return end

		if hum.PlatformStand then hum.PlatformStand = false end
		if hum.Sit then hum.Sit = false end

		local st = hum:GetState()
		if st == Enum.HumanoidStateType.Ragdoll
			or st == Enum.HumanoidStateType.FallingDown
			or st == Enum.HumanoidStateType.Physics then
			pcall(function()
				hum:ChangeState(Enum.HumanoidStateType.GettingUp)
			end)
		end

		for _, d in ipairs(char:GetDescendants()) do
			if d:IsA("Motor6D") and d.Enabled == false then
				d.Enabled = true
			end
		end
	end)
end

-- ===== Anti Fall (Chống ngã) =====
local function setAntiFall(state)
	antiFall = state
	if antiFallConn then antiFallConn:Disconnect() antiFallConn = nil end
	if not antiFall then return end

	antiFallConn = RunService.Heartbeat:Connect(function()
		local char = player.Character
		if not char then return end
		local hum = char:FindFirstChildOfClass("Humanoid")
		if not hum then return end

		if hum.PlatformStand then hum.PlatformStand = false end
		if hum.Sit then hum.Sit = false end

		local st = hum:GetState()
		if st == Enum.HumanoidStateType.FallingDown
			or st == Enum.HumanoidStateType.Ragdoll
			or st == Enum.HumanoidStateType.Physics then
			pcall(function()
				hum:ChangeState(Enum.HumanoidStateType.GettingUp)
				task.defer(function()
					if antiFall and hum.Parent then
						hum:ChangeState(Enum.HumanoidStateType.Running)
					end
				end)
			end)
		end
	end)
end

-- ===== Ground reset =====
local function hookGroundReset()
	local hum = getHumanoid()
	hum.StateChanged:Connect(function(_, newState)
		if newState == Enum.HumanoidStateType.Landed
			or newState == Enum.HumanoidStateType.Running
			or newState == Enum.HumanoidStateType.RunningNoPhysics then
			usedAir = 0
		end
	end)
end
hookGroundReset()

-- ===== UI: KEY =====
local keyBox = mk("Frame", {
	Name="KeyBox",
	Size=UDim2.new(0, 360, 0, 190),
	Position=UDim2.new(0.5, -180, 0.5, -95),
	BackgroundTransparency=0.12
}, gui)

mk("TextLabel", {
	Size=UDim2.new(1, -20, 0, 30),
	Position=UDim2.new(0, 10, 0, 10),
	BackgroundTransparency=1,
	TextScaled=true,
	Text="NHẬP KEY ĐỂ MỞ 2 GUI"
}, keyBox)

local input = mk("TextBox", {
	Size=UDim2.new(1, -20, 0, 42),
	Position=UDim2.new(0, 10, 0, 55),
	TextScaled=true,
	PlaceholderText="Nhập key",
	ClearTextOnFocus=false,
	Text=""
}, keyBox)

local msg = mk("TextLabel", {
	Size=UDim2.new(1, -20, 0, 24),
	Position=UDim2.new(0, 10, 0, 103),
	BackgroundTransparency=1,
	TextScaled=true,
	Text=""
}, keyBox)

local btn = mk("TextButton", {
	Size=UDim2.new(1, -20, 0, 42),
	Position=UDim2.new(0, 10, 0, 135),
	TextScaled=true,
	Text="XÁC NHẬN"
}, keyBox)

-- Panels refs
local leftPanel, rightPanel
local infToggle, finToggle, finMaxLbl, finBoostLbl
local flyBtn, speedLbl, flySpeedLbl, antiBtn, antiFallBtn, ghostBtn, ghostStepBtn, trainingBtn

local function refreshLeftUI()
	if infToggle then infToggle.Text = infJump and "INF JUMP: BẬT" or "INF JUMP: TẮT" end
	if finToggle then finToggle.Text = finEnabled and "FINITE JUMP: BẬT" or "FINITE JUMP: TẮT" end
	if finMaxLbl then finMaxLbl.Text = ("SỐ NHẢY: %d"):format(finMaxAir) end
	if finBoostLbl then finBoostLbl.Text = ("LỰC NHẢY: %d"):format(finBoost) end
end

local function refreshRightUI()
	if flyBtn then flyBtn.Text = flyEnabled and "BAY: BẬT" or "BAY: TẮT" end
	if speedLbl then speedLbl.Text = ("SPEED: %d"):format(walkSpeed) end
	if flySpeedLbl then flySpeedLbl.Text = ("FLY SPEED: %d"):format(flySpeed) end
	if antiBtn then antiBtn.Text = antiRagdoll and "ANTI RAGDOLL: BẬT" or "ANTI RAGDOLL: TẮT" end
	if antiFallBtn then antiFallBtn.Text = antiFall and "CHỐNG NGÃ: BẬT" or "CHỐNG NGÃ: TẮT" end
	if ghostBtn then ghostBtn.Text = ghostEnabled and "GHOST MODE: BẬT" or "GHOST MODE: TẮT" end
	if trainingBtn then trainingBtn.Text = trainingEnabled and "TRAINING MODE: BẬT" or "TRAINING MODE: TẮT" end
end

local function createPanels()
	-- LEFT (Jump)
	leftPanel = mk("Frame", {
		Name="LeftPanel",
		Size=UDim2.new(0, 320, 0, 270),
		Position=UDim2.new(0, 20, 0, 20),
		BackgroundTransparency=0.15
	}, gui)

	mk("TextLabel", {
		Size=UDim2.new(1, -20, 0, 28),
		Position=UDim2.new(0, 10, 0, 6),
		BackgroundTransparency=1,
		TextScaled=true,
		TextXAlignment=Enum.TextXAlignment.Left,
		Text="JUMP"
	}, leftPanel)

	infToggle = mk("TextButton", {
		Size=UDim2.new(1, -20, 0, 38),
		Position=UDim2.new(0, 10, 0, 40),
		TextScaled=true
	}, leftPanel)

	finToggle = mk("TextButton", {
		Size=UDim2.new(1, -20, 0, 38),
		Position=UDim2.new(0, 10, 0, 82),
		TextScaled=true
	}, leftPanel)

	finMaxLbl = mk("TextLabel", {
		Size=UDim2.new(0.55, -15, 0, 34),
		Position=UDim2.new(0, 10, 0, 128),
		BackgroundTransparency=1,
		TextScaled=true,
		TextXAlignment=Enum.TextXAlignment.Left
	}, leftPanel)

	local finMaxMinus = mk("TextButton", {
		Size=UDim2.new(0, 45, 0, 34),
		Position=UDim2.new(0.55, 0, 0, 128),
		TextScaled=true,
		Text="-"
	}, leftPanel)

	local finMaxPlus = mk("TextButton", {
		Size=UDim2.new(0, 45, 0, 34),
		Position=UDim2.new(0.55, 50, 0, 128),
		TextScaled=true,
		Text="+"
	}, leftPanel)

	finBoostLbl = mk("TextLabel", {
		Size=UDim2.new(0.55, -15, 0, 34),
		Position=UDim2.new(0, 10, 0, 170),
		BackgroundTransparency=1,
		TextScaled=true,
		TextXAlignment=Enum.TextXAlignment.Left
	}, leftPanel)

	local finBoostMinus = mk("TextButton", {
		Size=UDim2.new(0, 45, 0, 34),
		Position=UDim2.new(0.55, 0, 0, 170),
		TextScaled=true,
		Text="-"
	}, leftPanel)

	local finBoostPlus = mk("TextButton", {
		Size=UDim2.new(0, 45, 0, 34),
		Position=UDim2.new(0.55, 50, 0, 170),
		TextScaled=true,
		Text="+"
	}, leftPanel)

	mk("TextLabel", {
		Size=UDim2.new(1, -20, 0, 30),
		Position=UDim2.new(0, 10, 0, 220),
		BackgroundTransparency=1,
		TextScaled=true,
		Text="P: ẩn/hiện 2 bảng"
	}, leftPanel)

	-- RIGHT
	rightPanel = mk("Frame", {
		Name="RightPanel",
		Size=UDim2.new(0, 320, 0, 560), -- đủ chỗ cho admin tools
		Position=UDim2.new(1, -340, 0, 20),
		BackgroundTransparency=0.15
	}, gui)

	mk("TextLabel", {
		Size=UDim2.new(1, -20, 0, 28),
		Position=UDim2.new(0, 10, 0, 6),
		BackgroundTransparency=1,
		TextScaled=true,
		TextXAlignment=Enum.TextXAlignment.Left,
		Text="BAY / SPEED / ANTI"
	}, rightPanel)

	flyBtn = mk("TextButton", {
		Size=UDim2.new(1, -20, 0, 42),
		Position=UDim2.new(0, 10, 0, 40),
		TextScaled=true
	}, rightPanel)

	speedLbl = mk("TextLabel", {
		Size=UDim2.new(0.55, -15, 0, 34),
		Position=UDim2.new(0, 10, 0, 92),
		BackgroundTransparency=1,
		TextScaled=true,
		TextXAlignment=Enum.TextXAlignment.Left
	}, rightPanel)

	local speedMinus = mk("TextButton", {
		Size=UDim2.new(0, 45, 0, 34),
		Position=UDim2.new(0.55, 0, 0, 92),
		TextScaled=true,
		Text="-"
	}, rightPanel)

	local speedPlus = mk("TextButton", {
		Size=UDim2.new(0, 45, 0, 34),
		Position=UDim2.new(0.55, 50, 0, 92),
		TextScaled=true,
		Text="+"
	}, rightPanel)

	flySpeedLbl = mk("TextLabel", {
		Size=UDim2.new(0.55, -15, 0, 34),
		Position=UDim2.new(0, 10, 0, 134),
		BackgroundTransparency=1,
		TextScaled=true,
		TextXAlignment=Enum.TextXAlignment.Left
	}, rightPanel)

	local flySpeedMinus = mk("TextButton", {
		Size=UDim2.new(0, 45, 0, 34),
		Position=UDim2.new(0.55, 0, 0, 134),
		TextScaled=true,
		Text="-"
	}, rightPanel)

	local flySpeedPlus = mk("TextButton", {
		Size=UDim2.new(0, 45, 0, 34),
		Position=UDim2.new(0.55, 50, 0, 134),
		TextScaled=true,
		Text="+"
	}, rightPanel)

	antiBtn = mk("TextButton", {
		Size=UDim2.new(1, -20, 0, 38),
		Position=UDim2.new(0, 10, 0, 178),
		TextScaled=true
	}, rightPanel)

	antiFallBtn = mk("TextButton", {
		Size=UDim2.new(1, -20, 0, 38),
		Position=UDim2.new(0, 10, 0, 220),
		TextScaled=true
	}, rightPanel)

	ghostBtn = mk("TextButton", {
		Size=UDim2.new(1, -20, 0, 38),
		Position=UDim2.new(0, 10, 0, 262),
		TextScaled=true
	}, rightPanel)

	ghostStepBtn = mk("TextButton", {
		Size=UDim2.new(1, -20, 0, 38),
		Position=UDim2.new(0, 10, 0, 304),
		TextScaled=true,
		Text="GHOST STEP"
	}, rightPanel)

	trainingBtn = mk("TextButton", {
		Size=UDim2.new(1, -20, 0, 38),
		Position=UDim2.new(0, 10, 0, 346),
		TextScaled=true
	}, rightPanel)

	-- ===== ADMIN TOOLS SAFE (chỉ hiện nếu isAdmin=true) =====
	if isAdmin() then
		local adminFrame = mk("Frame", {
			Name="AdminFrame",
			Size = UDim2.new(1, -20, 0, 210),
			Position = UDim2.new(0, 10, 0, 392),
			BackgroundTransparency = 0.2
		}, rightPanel)

		mk("TextLabel", {
			Size = UDim2.new(1, -10, 0, 24),
			Position = UDim2.new(0, 5, 0, 5),
			BackgroundTransparency = 1,
			TextScaled = true,
			Text = "ADMIN TOOLS (CHỈ CHO BẠN)"
		}, adminFrame)

		local tpSpawn = mk("TextButton", {
			Size = UDim2.new(1, -10, 0, 34),
			Position = UDim2.new(0, 5, 0, 34),
			TextScaled = true,
			Text = "TELEPORT: SPAWN"
		}, adminFrame)

		local tpSafe = mk("TextButton", {
			Size = UDim2.new(1, -10, 0, 34),
			Position = UDim2.new(0, 5, 0, 72),
			TextScaled = true,
			Text = "TELEPORT: SAFEZONE"
		}, adminFrame)

		local healMe = mk("TextButton", {
			Size = UDim2.new(0.49, -8, 0, 34),
			Position = UDim2.new(0, 5, 0, 110),
			TextScaled = true,
			Text = "HEAL ME"
		}, adminFrame)

		local resetMe = mk("TextButton", {
			Size = UDim2.new(0.49, -8, 0, 34),
			Position = UDim2.new(0.51, 3, 0, 110),
			TextScaled = true,
			Text = "RESET ME"
		}, adminFrame)

		local gravityBtn = mk("TextButton", {
			Size = UDim2.new(1, -10, 0, 34),
			Position = UDim2.new(0, 5, 0, 148),
			TextScaled = true,
			Text = "GRAVITY: BÌNH THƯỜNG"
		}, adminFrame)

		local function tpToPart(partName)
			local char = player.Character
			if not char then return end
			local hrp = char:FindFirstChild("HumanoidRootPart")
			if not hrp then return end

			local p = workspace:FindFirstChild(partName)
			if not p or not p:IsA("BasePart") then
				notify("ADMIN", "Không thấy Part: "..partName, 2)
				return
			end
			hrp.CFrame = p.CFrame + Vector3.new(0, 5, 0)
		end

		tpSpawn.MouseButton1Click:Connect(function()
			local spawn = workspace:FindFirstChildOfClass("SpawnLocation")
			if spawn then
				tpToPart(spawn.Name)
			else
				notify("ADMIN", "Không thấy SpawnLocation", 2)
			end
		end)

		tpSafe.MouseButton1Click:Connect(function()
			tpToPart("SafeZone") -- bạn tạo Part SafeZone trong Workspace
		end)

		healMe.MouseButton1Click:Connect(function()
			local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
			if hum then hum.Health = hum.MaxHealth end
		end)

		resetMe.MouseButton1Click:Connect(function()
			local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
			if hum then hum.Health = 0 end
		end)

		local lowG = false
		local normalG = workspace.Gravity
		gravityBtn.MouseButton1Click:Connect(function()
			lowG = not lowG
			workspace.Gravity = lowG and 60 or normalG
			gravityBtn.Text = lowG and "GRAVITY: THẤP" or "GRAVITY: BÌNH THƯỜNG"
		end)
	end

	-- ===== Events =====
	infToggle.MouseButton1Click:Connect(function()
		infJump = not infJump
		refreshLeftUI()
	end)

	finToggle.MouseButton1Click:Connect(function()
		finEnabled = not finEnabled
		refreshLeftUI()
	end)

	finMaxMinus.MouseButton1Click:Connect(function()
		finMaxAir = clamp(finMaxAir - 1, 0, FIN_MAX_LIMIT)
		refreshLeftUI()
	end)
	finMaxPlus.MouseButton1Click:Connect(function()
		finMaxAir = clamp(finMaxAir + 1, 0, FIN_MAX_LIMIT)
		refreshLeftUI()
	end)

	finBoostMinus.MouseButton1Click:Connect(function()
		finBoost = clamp(finBoost - 5, 10, FIN_BOOST_LIMIT)
		refreshLeftUI()
	end)
	finBoostPlus.MouseButton1Click:Connect(function()
		finBoost = clamp(finBoost + 5, 10, FIN_BOOST_LIMIT)
		refreshLeftUI()
	end)

	flyBtn.MouseButton1Click:Connect(function()
		if flyEnabled then stopFly() else startFly() end
		refreshRightUI()
	end)

	speedMinus.MouseButton1Click:Connect(function()
		walkSpeed = clamp(walkSpeed - WALK_STEP, WALK_MIN, WALK_MAX)
		applyWalkSpeed()
		refreshRightUI()
	end)
	speedPlus.MouseButton1Click:Connect(function()
		walkSpeed = clamp(walkSpeed + WALK_STEP, WALK_MIN, WALK_MAX)
		applyWalkSpeed()
		refreshRightUI()
	end)

	flySpeedMinus.MouseButton1Click:Connect(function()
		flySpeed = clamp(flySpeed - FLY_STEP, FLY_MIN, FLY_MAX)
		refreshRightUI()
	end)
	flySpeedPlus.MouseButton1Click:Connect(function()
		flySpeed = clamp(flySpeed + FLY_STEP, FLY_MIN, FLY_MAX)
		refreshRightUI()
	end)

	antiBtn.MouseButton1Click:Connect(function()
		setAntiRagdoll(not antiRagdoll)
		refreshRightUI()
	end)

	antiFallBtn.MouseButton1Click:Connect(function()
		setAntiFall(not antiFall)
		refreshRightUI()
	end)

	ghostBtn.MouseButton1Click:Connect(function()
		setGhostMode(not ghostEnabled)
		refreshRightUI()
	end)

	ghostStepBtn.MouseButton1Click:Connect(function()
		GhostStep(6)
	end)

	trainingBtn.MouseButton1Click:Connect(function()
		setTrainingMode(not trainingEnabled)
		refreshRightUI()
	end)

	refreshLeftUI()
	applyWalkSpeed()
	setAntiRagdoll(false)
	setAntiFall(false)
	setGhostMode(false)
	setTrainingMode(false)
	refreshRightUI()
end

-- INPUT: Jump + panel toggle
UserInputService.InputBegan:Connect(function(inputObj, gp)
	if gp then return end
	if not access then return end

	if inputObj.KeyCode == Enum.KeyCode.P and leftPanel and rightPanel then
		local v = not leftPanel.Visible
		leftPanel.Visible = v
		rightPanel.Visible = v
		return
	end

	if inputObj.KeyCode == Enum.KeyCode.Space then
		local hum = getHumanoid()
		local hrp = getHRP()

		-- Nếu chưa bật inf/finite: chặn double jump của game (nếu có)
		if (not infJump) and (not finEnabled) then
			if not isGrounded(hum) then
				local now = tick()
				if now - lastSpaceAt < 0.5 then return end
				lastSpaceAt = now
			end
			return
		end

		-- INF JUMP
		if infJump then
			if not isGrounded(hum) then
				local v = hrp.AssemblyLinearVelocity
				hrp.AssemblyLinearVelocity = Vector3.new(v.X, math.max(v.Y, finBoost), v.Z)
			end
			return
		end

		-- FINITE JUMP
		if finEnabled then
			if isGrounded(hum) then
				usedAir = 0
				return
			end
			if usedAir >= finMaxAir then return end
			usedAir += 1
			local v = hrp.AssemblyLinearVelocity
			hrp.AssemblyLinearVelocity = Vector3.new(v.X, math.max(v.Y, finBoost), v.Z)
		end
	end
end)

player.CharacterAdded:Connect(function()
	stopFly()
	if ghostConn then ghostConn:Disconnect() ghostConn = nil end
	if trainingConn then trainingConn:Disconnect() trainingConn = nil end
	if antiRagConn then antiRagConn:Disconnect() antiRagConn = nil end
	if antiFallConn then antiFallConn:Disconnect() antiFallConn = nil end

	task.wait(0.1)
	applyWalkSpeed()
	if antiRagdoll then setAntiRagdoll(true) end
	if antiFall then setAntiFall(true) end
	if ghostEnabled then setGhostMode(true) end
	if trainingEnabled then setTrainingMode(true) end

	usedAir = 0
	hookGroundReset()
end)

-- KEY (không khóa, không chờ)
btn.MouseButton1Click:Connect(function()
	local k = (input.Text or ""):upper():gsub("%s+", "")
	if k == KEY_OK then
		access = true
		msg.Text = "✅ KEY ĐÚNG"
		keyBox.Visible = false
		createPanels()
		notify("OK", "Script đã load xong ✅", 3)
	else
		msg.Text = "❌ KEY SAI"
		notify("KEY", "Key sai ❌ Vui lòng nhập lại.", 2)
	end
end)
